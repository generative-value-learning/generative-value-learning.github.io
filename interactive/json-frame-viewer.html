<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Frame Viewer</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .upload-container {
            text-align: center;
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .viewer-container {
            display: none;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .task-info {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        .frame-container {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        .frame-navigation {
            display: flex;
            gap: 10px;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }
        .frame-info {
            flex: 1;
        }
        .frame-image {
            flex: 2;
            text-align: center;
        }
        .frame-image img {
            max-width: 100%;
            max-height: 500px;
        }
        .plot-container {
            flex: 1;
            min-height: 400px;
        }
        button {
            padding: 8px 16px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        button:hover:not(:disabled) {
            background-color: #0056b3;
        }
        .error {
            color: red;
            padding: 10px;
            display: none;
        }
        .frame-slider {
            flex-grow: 1;
            margin: 0 10px;
        }
        input[type="range"] {
            width: 100%;
        }
        #frameCounter {
            min-width: 100px;
            text-align: center;
        }
        select {
            padding: 8px;
            font-size: 16px;
            width: 80%;
            max-width: 800px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="upload-container">
        <select id="fileSelect">
            <option value="">Select a task...</option>
            <optgroup label="Overhead Camera">
                <option value="overhead_cam_banana-handover_example1_final_v0_094b179a00e040ed9f9cc86ba421dc75.json">Banana Handover</option>
                <option value="overhead_cam_bowl-in-rack_example1_final_v0_5fe3095ba41c4a96821b82246c645dba.json">Bowl in Rack</option>
            </optgroup>
            <optgroup label="Worms Eye Camera">
                <option value="worms_eye_cam_banana-handover_example1_final_v0_00fea4d4752b4214b1d2cd76af7b2133.json">Banana Handover</option>
                <option value="worms_eye_cam_bowl-in-rack_example1_final_v0_a8479844d22e4b949117a5c712a760ac.json">Bowl in Rack</option>
            </optgroup>
            <optgroup label="Left Wrist Camera">
                <option value="wrist_cam_left_banana-handover_example1_final_v0_26752f8f33d94e0ba4da6dde4ad2578c.json">Banana Handover</option>
                <option value="wrist_cam_left_bowl-in-rack_example1_final_v0_a2f82b99a10e4568a5910e2b8cfda9a8.json">Bowl in Rack</option>
            </optgroup>
        </select>
        <div id="error" class="error"></div>
    </div>

    <div id="viewer" class="viewer-container">
        <!-- <div class="task-info">
            <h3>Task Information</h3>
            <p><strong>Task ID:</strong> <span id="taskId"></span></p>
            <p><strong>Description:</strong> <span id="taskDescription"></span></p>
        </div> -->

        <div class="frame-navigation">
            <span id="frameCounter"></span>
            <div class="frame-slider">
                <input type="range" id="frameSlider" min="0" max="0" value="0">
            </div>
            <button id="playButton">Play</button>
        </div>

        <div class="frame-container">
            <div class="frame-info">
                <p style="display: none;"><strong>Frame ID:</strong> <span id="frameId"></span></p>
                <p style="display: none;"><strong>Number:</strong> <span id="frameNumber"></span></p>
                <p style="display: none;"><strong>Order:</strong> <span id="frameOrder"></span></p>
                <p><strong>Description:</strong> <span id="frameDescription"></span></p>
                <div class="frame-image">
                    <img id="frameImage" alt="Frame">
                </div>
            </div>
            <div id="plotContainer" class="plot-container"></div>
        </div>
    </div>

    <script>
        let currentData = null;
        let currentFrameIndex = 0;
        let playInterval = null;

        document.getElementById('fileSelect').addEventListener('change', handleFileSelect);
        document.getElementById('frameSlider').addEventListener('input', handleSliderChange);
        document.getElementById('playButton').addEventListener('click', togglePlay);

        function handleSliderChange(event) {
            currentFrameIndex = parseInt(event.target.value);
            updateView();
            updatePlot();
        }

        function handleFileSelect(event) {
            const filename = event.target.value;
            if (!filename) return;

            fetch(filename)
                .then(response => response.json())
                .then(json => {
                    validateAndLoadData(json);
                })
                .catch(error => {
                    showError('Error loading file');
                });
        }

        function validateAndLoadData(json) {
            if (!json.task_description || !json.task_id || !Array.isArray(json.frames)) {
                showError('Invalid JSON structure');
                return;
            }

            currentData = json;
            currentFrameIndex = 0;
            document.getElementById('viewer').style.display = 'block';
            document.getElementById('error').style.display = 'none';
            
            // Update slider max value
            const slider = document.getElementById('frameSlider');
            slider.max = currentData.frames.length - 1;
            slider.value = 0;
            
            updateView();
            createPlot();
        }

        function togglePlay() {
            const playButton = document.getElementById('playButton');
            if (playInterval) {
                clearInterval(playInterval);
                playInterval = null;
                playButton.textContent = 'Play';
            } else {
                playButton.textContent = 'Pause';
                playInterval = setInterval(() => {
                    if (currentFrameIndex === currentData.frames.length - 1) {
                        clearInterval(playInterval);
                        playInterval = null;
                        playButton.textContent = 'Play';
                        return;
                    }
                    currentFrameIndex++;
                    document.getElementById('frameSlider').value = currentFrameIndex;
                    updateView();
                    updatePlot();
                }, 333); // 3 FPS = 333ms per frame
            }
        }
        function createPlot() {
            const frameIds = currentData.frames.slice(0, currentFrameIndex + 1).map(frame => frame.frame_id);
            const numbers = currentData.frames.slice(0, currentFrameIndex + 1).map(frame => frame.number);

            const trace = {
                x: frameIds,
                y: numbers,
                mode: 'lines+markers',
                type: 'scatter',
                name: 'Task Progress'
            };

            const layout = {
                title: 'Task Progress Over Frames',
                xaxis: {
                    title: 'Ground truth frame order',
                    range: [0, currentData.frames.length]
                },
                yaxis: {
                    title: 'Gemini Predicted Value Function',
                    range: [0, 100]
                }
            };

            Plotly.newPlot('plotContainer', [trace], layout);
        }

        function updatePlot() {
            const frameIds = currentData.frames.slice(0, currentFrameIndex + 1).map(frame => frame.frame_id);
            const numbers = currentData.frames.slice(0, currentFrameIndex + 1).map(frame => frame.number);

            const trace = {
                x: frameIds,
                y: numbers,
                mode: 'lines+markers',
                type: 'scatter',
                name: 'Task Progress'
            };
            const layout = {
                title: 'Task Progress Over Frames',
                xaxis: {
                    title: 'Ground truth frame order',
                    range: [0, currentData.frames.length]
                },
                yaxis: {
                    title: 'Gemini Predicted Value Function', 
                    range: [0, 100]
                }
            };

            Plotly.react('plotContainer', [trace], layout);
        }

        function updateView() {
            if (!currentData) return;

            // Update task information
            document.getElementById('taskId').textContent = currentData.task_id;
            document.getElementById('taskDescription').textContent = currentData.task_description;

            // Update frame counter
            document.getElementById('frameCounter').textContent = 
                `Frame ${currentFrameIndex + 1} of ${currentData.frames.length}`;

            // Update frame information
            const frame = currentData.frames[currentFrameIndex];
            document.getElementById('frameId').textContent = frame.frame_id;
            document.getElementById('frameNumber').textContent = frame.number;
            document.getElementById('frameOrder').textContent = frame.frame_order;
            document.getElementById('frameDescription').textContent = frame.frame_description;
            document.getElementById('frameImage').src = frame.frame;
        }

        function showError(message) {
            const errorElement = document.getElementById('error');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            document.getElementById('viewer').style.display = 'none';
        }
    </script>
</body>
</html>
